<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Excel → Gráficos Interativos (GitHub Pages)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--accent:#22c55e;--brand:#38bdf8;--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 800px at 90% -20%,#1f2937 0%,#0b1020 55%),#0b1020;color:var(--text);font:500 15px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    header{padding:20px 24px;display:flex;gap:18px;align-items:center;justify-content:space-between;border-bottom:1px solid #1e293b;background:linear-gradient(180deg,#0f172a,transparent)}
    .brand{display:flex;align-items:center;gap:12px}
    .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 0deg,#22c55e,#06b6d4,#8b5cf6,#22c55e)}
    h1{font-size:16px;margin:0;color:#e2e8f0;font-weight:700}
    main{display:grid;grid-template-columns:320px 1fr;gap:18px;padding:18px;height:calc(100% - 70px)}
    aside{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #1f2a44;border-radius:var(--radius);padding:16px;overflow:auto}
    .panel{display:grid;gap:10px}
    label{font-size:12px;color:var(--muted)}
    select,input[type="text"],input[type="number"],button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #22304d;background:#0b1327;color:var(--text)}
    button{cursor:pointer;font-weight:700;background:linear-gradient(180deg,#0ea5e9,#0284c7);border:1px solid #0ea5e9}
    button.secondary{background:#101a33;border-color:#22304d}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted)}
    #chart{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #1f2a44;border-radius:var(--radius);padding:8px;height:100%;min-height:480px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #2b3c60;border-radius:999px;color:#cbd5e1}
    .footer{font-size:12px;color:#94a3b8;opacity:.8}
    a{color:#7dd3fc;text-decoration:none}
    .ok{color:#34d399}.warn{color:#f59e0b}.err{color:#ef4444}
    @media (max-width: 960px){main{grid-template-columns:1fr}} 
  </style>
  <!-- Removemos scripts diretos e passamos a carregar com fallback dinâmico (evita "XLSX is not defined") -->
</head>
<body>
  <header>
    <div class="brand"><div class="dot"></div><h1>Dashboard Excel → Gráficos Interativos</h1></div>
    <div class="toolbar">
      <span class="badge">Armazenamento: <strong>GitHub Repo</strong></span>
      <span class="badge">Formato fonte: <strong>.xlsx</strong> <span class="ok">(sem CSV)</span></span>
      <span class="badge">Hospedagem: <strong>GitHub Pages</strong></span>
    </div>
  </header>

  <main>
    <aside>
      <div class="panel">
        <div>
          <label>Fonte de dados (.xlsx) no repositório</label>
          <input id="xlsxPath" type="text" value="data/Bimestral.xlsx" />
          <div class="hint">Dica: coloque seu arquivo em <code>data/</code> e ajuste o caminho.</div>
        </div>
        <div class="row">
          <button id="btnLoad">Carregar do repositório</button>
          <button id="btnUpload" class="secondary">Selecionar arquivo local</button>
          <input id="filePicker" type="file" accept=".xlsx,.xls" hidden />
        </div>
        <div>
          <label>Planilha (aba)</label>
          <select id="sheet"></select>
        </div>
        <hr style="border-color:#1f2a44;opacity:.6" />
        <button id="btnMath">Gráfico pronto: Matemática (%≥6 por turma)</button>
        <button id="btnPort">Gráfico pronto: Português (%≥6 por turma)</button>
        <button id="btnCompare">Comparar Matemática × Português (%≥6)</button>
        <button id="btnTests" class="secondary">Rodar testes</button>
        <hr style="border-color:#1f2a44;opacity:.6" />
        <div class="footer">
          <strong>Como publicar:</strong>
          <ol>
            <li>Crie um repositório: <code>seu-usuario/seu-dashboard</code>.</li>
            <li>Adicione este <code>index.html</code> na raiz e a pasta <code>data/</code> com <code>Bimestral.xlsx</code>.</li>
            <li>Ative GitHub Pages em Settings → Pages → Deploy from branch → main / root.</li>
            <li>Acesse a URL do Pages.</li>
          </ol>
        </div>
      </div>
    </aside>

    <section id="chart">
      <div class="toolbar" id="status" style="margin:8px 0 0 8px"></div>
      <div id="chartHost" style="width:100%;height:100%"></div>
    </section>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const state = { wb: null, dataBySheet: {}, columns: [] };

  // ===== Utilidades de status =====
  function tag(msg, ok=true){
    const span = document.createElement('span');
    span.className = 'badge';
    span.style.borderColor = ok ? '#1fa37f' : '#ef4444';
    span.textContent = msg; return span;
  }
  function setStatus(msg, ok=true){ const box = $('status'); box.innerHTML=''; box.appendChild(tag(msg, ok)); }
  function pushStatus(msg, ok=true){ const box = $('status'); box.appendChild(tag(msg, ok)); }

  // ===== Loader com fallback de CDN (corrige XLSX is not defined) =====
  const XLSX_URLS = [
    'https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
    'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
  ];
  const PLOTLY_URLS = [
    'https://cdn.plot.ly/plotly-2.35.2.min.js',
    'https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.35.2/plotly.min.js'
  ];

  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=src; s.async=false; s.crossOrigin='anonymous';
      s.onload=()=>resolve(src);
      s.onerror=()=>reject(new Error('Falha ao carregar '+src));
      document.head.appendChild(s);
    });
  }

  async function loadWithFallback(name, urls){
    for(const u of urls){
      try{ await loadScript(u); pushStatus(name+': ok via '+(new URL(u)).hostname, true); return; }
      catch(e){ pushStatus(name+': falhou '+(new URL(u)).hostname, false); }
    }
    throw new Error('Não foi possível carregar '+name+' de nenhum CDN');
  }

  // ===== Funções de planilha =====
  function normalizeMultiHeader(ws){
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
    if(rows.length < 3) return null;
    const top = rows[0];
    const sub = rows[1];
    const headers = [];
    for(let c=0;c<Math.max(top.length, sub.length);c++){
      const A = top[c], B = sub[c];
      let name = A && B ? `${A}|${B}` : (A || B || `col_${c}`);
      headers.push(String(name).trim());
    }
    const body = rows.slice(2).filter(r => r.some(v => v!==null && v!==''))
      .map(r => Object.fromEntries(headers.map((h,i)=>[h, r[i] ?? null])));
    return { headers, body };
  }

  function sheetToJSON(name){
    const ws = state.wb.Sheets[name];
    const normalized = normalizeMultiHeader(ws);
    if(normalized){ state.dataBySheet[name] = normalized.body; state.columns = normalized.headers; return normalized.body; }
    const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
    state.dataBySheet[name] = rows; state.columns = guessColumns(rows); return rows;
  }

  function guessColumns(rows){ const cols = new Set(); rows.forEach(r => Object.keys(r).forEach(k => cols.add(k))); return Array.from(cols); }
  function pickX(rows){ const prefer=["Turma","Bimestre","Bimestres","Série","Classe"]; for(const k of prefer){ if(rows.length && (k in rows[0])) return k; } return rows.length?Object.keys(rows[0])[0]:null; }

  function plotCustom(sheetName, yCol){
    const rows = state.dataBySheet[sheetName] || sheetToJSON(sheetName);
    const xKey = pickX(rows); if(!xKey) return alert('Não encontrei coluna para eixo X (ex.: Turma/Bimestre).');
    const x = rows.map(r => r[xKey]); const y = rows.map(r => Number(r[yCol]));
    const trace = { type:'bar', x, y, name: yCol };
    const layout = { title: yCol, barmode:'group', font:{color:'#e2e8f0'}, paper_bgcolor:'transparent', plot_bgcolor:'transparent', xaxis:{gridcolor:'#1f2a44'}, yaxis:{gridcolor:'#1f2a44'} };
    Plotly.newPlot('chartHost', [trace], layout, {responsive:true, displaylogo:false});
  }

  function plotCompare(sheetName, yColA, yColB){
    const rows = state.dataBySheet[sheetName] || sheetToJSON(sheetName);
    const xKey = pickX(rows); if(!xKey) return alert('Não encontrei coluna para eixo X.');
    const x = rows.map(r => r[xKey]);
    const yA = rows.map(r => Number(r[yColA]));
    const yB = rows.map(r => Number(r[yColB]));
    const traces = [ {type:'bar', x, y:yA, name:yColA}, {type:'bar', x, y:yB, name:yColB} ];
    const layout = { title:`${yColA} × ${yColB}`, barmode:'group', font:{color:'#e2e8f0'}, paper_bgcolor:'transparent', plot_bgcolor:'transparent', xaxis:{gridcolor:'#1f2a44'}, yaxis:{gridcolor:'#1f2a44'} };
    Plotly.newPlot('chartHost', traces, layout, {responsive:true, displaylogo:false});
  }

  function readWorkbook(array){
    const wb = XLSX.read(array, { type:'array' }); state.wb = wb;
    const sheetSel = $('sheet'); sheetSel.innerHTML='';
    wb.SheetNames.forEach((name, idx)=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; if(idx===0) opt.selected=true; sheetSel.appendChild(opt); });
    if(wb.SheetNames.length){ plotCustom(wb.SheetNames[0], 'Matemática|%≥6'); }
  }

  async function fetchXlsx(path){ const res = await fetch(path); if(!res.ok) throw new Error('Não foi possível carregar o arquivo: '+res.status+' '+path); return await res.arrayBuffer(); }

  // ===== Testes automáticos (adição solicitada) =====
  function runTests(){
    const results = [];
    try{ results.push(['XLSX disponível', !!window.XLSX]); }catch{ results.push(['XLSX disponível', false]); }
    try{ results.push(['Plotly disponível', !!window.Plotly]); }catch{ results.push(['Plotly disponível', false]); }
    // Teste prático: cria uma planilha simples e valida leitura
    try{
      const aoa = [['Nome','Nota'],['Ana',9],['Beto',7]];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const json = XLSX.utils.sheet_to_json(ws, {defval:null});
      const ok = Array.isArray(json) && json.length===2 && json[0].Nome==='Ana' && json[1].Nota===7;
      results.push(['sheet_to_json funciona', ok]);
    }catch(e){ results.push(['sheet_to_json funciona', false]); }
    // Exibe
    const okAll = results.every(r=>r[1]);
    setStatus('Testes: '+results.map(r=>`${r[0]}=${r[1]?'OK':'ERRO'}`).join(' | '), okAll);
    console.table(Object.fromEntries(results));
  }

  // ===== Inicialização =====
  async function boot(){
    try{
      setStatus('Carregando bibliotecas…');
      await Promise.all([ loadWithFallback('XLSX', XLSX_URLS), loadWithFallback('Plotly', PLOTLY_URLS) ]);
      setStatus('Bibliotecas carregadas', true);
      runTests();
      // Eventos UI
      $('btnLoad').addEventListener('click', async ()=>{ try{ const buf=await fetchXlsx($('xlsxPath').value.trim()); readWorkbook(new Uint8Array(buf)); setStatus('Arquivo carregado com sucesso', true);}catch(e){ setStatus(e.message,false); alert(e.message);} });
      $('btnUpload').addEventListener('click', ()=>$('filePicker').click());
      $('filePicker').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const buf=await f.arrayBuffer(); readWorkbook(new Uint8Array(buf)); setStatus('Arquivo local carregado', true); });
      $('sheet').addEventListener('change', ()=>{ const s=$('sheet').value; if(s) plotCustom(s, 'Matemática|%≥6'); });
      $('btnMath').addEventListener('click',()=>{ const s=$('sheet').value; if(s) plotCustom(s, 'Matemática|%≥6'); else alert('Selecione uma planilha.'); });
      $('btnPort').addEventListener('click',()=>{ const s=$('sheet').value; if(s) plotCustom(s, 'Português|%≥6'); else alert('Selecione uma planilha.'); });
      $('btnCompare').addEventListener('click',()=>{ const s=$('sheet').value; if(s) plotCompare(s, 'Matemática|%≥6', 'Português|%≥6'); else alert('Selecione uma planilha.'); });
      $('btnTests').addEventListener('click', runTests);
      // Auto-carregar do repositório
      try{ const buf=await fetchXlsx($('xlsxPath').value.trim()); readWorkbook(new Uint8Array(buf)); setStatus('Auto-carregado a planilha do repositório', true); }catch(e){ setStatus('Auto-load falhou: '+e.message, false); }
    }catch(e){ setStatus('Falha na inicialização: '+e.message, false); console.error(e); }
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body>
</html>
