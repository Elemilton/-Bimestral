<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Disciplinas Detalhadas — Dashboard</title>
  <style>
    :root{--bg:#0f172a;--panel:#0b1428;--stroke:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--brand:#0284c7}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;overflow-x:hidden}
    header{padding:12px 16px;border-bottom:1px solid var(--stroke);display:flex;gap:12px;align-items:center}
    .container{max-width:1280px;margin:0 auto;padding:0 12px;width:100%}
    main{display:grid;grid-template-columns:390px 1fr;gap:14px;padding:14px}
    aside{background:linear-gradient(180deg,#0f172a,#0b1325);border:1px solid var(--stroke);border-radius:12px;padding:12px;align-self:start;position:sticky;top:14px;max-height:calc(100vh - 28px);overflow-y:auto;overflow-x:hidden}
    label{font-size:12px;color:var(--muted)}
    select,input[type="number"]{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #264161;background:#0b1b34;color:var(--text)}
    button{width:auto;padding:9px 14px;border-radius:10px;border:1px solid #0ea5e9;background:var(--brand);color:var(--text)}
    select[multiple]{height:220px} /* padrão para listas grandes */
    #bimSelect{height:auto}        /* Bimestres usa "size" e fica compacto */
    button{cursor:pointer;background:var(--brand);border-color:#0ea5e9;font-weight:600;width:auto;min-width:140px}
    button.tiny{padding:4px 8px;border-radius:8px;background:#1e293b;border:1px solid #475569;font-size:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stack{display:grid;gap:8px;min-width:0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
    .charts{display:grid;gap:18px}
    .chartBox{width:100%;height:560px;margin:0 auto;border:1px solid var(--stroke);border-radius:12px;background:linear-gradient(180deg,#0f172a,#0b1325)}
    .toolbar.compact label{display:flex;align-items:center;gap:6px;background:transparent;padding:4px 6px;border-radius:6px;border:1px solid #364156}
    .toolbar.compact input{width:auto}
    .label-actions{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    .mini{font-size:12px;opacity:.8}
  </style>
  <noscript>
    <style>main{display:none}</style>
    <div>Este dashboard precisa de JavaScript habilitado.</div>
  </noscript>
  <!-- Bibliotecas locais -->
  <script src="vendor/xlsx.full.min.js"></script>
  <script src="vendor/plotly-2.35.2.min.js"></script>
</head>
<body>
  <header class="container">
    <div style="font-weight:700">Dashboard - Disciplinas Detalhadas</div>
    <div id="status" style="margin-left:auto;font-size:12px;opacity:.85"></div>
  </header>

  <main class="container">
    <aside class="stack">

      <!-- 1) Bimestre (multi) -->
      <div class="stack">
        <div class="label-actions">
          <label>Bimestre (multi)</label>
          <span>
            <button class="tiny" id="btnBimAll">Selecionar todos</button>
            <button class="tiny" id="btnBimClear">Limpar</button>
          </span>
        </div>
        <!-- size controla a altura; o CSS #bimSelect{height:auto} deixa compacto -->
        <select id="bimSelect" multiple size="4"></select>
      </div>

      <div class="row">
        <div class="stack">
          <div class="label-actions">
            <label>Série/Turma (multi)</label>
            <span>
              <button class="tiny" id="btnClassAll">Selecionar todos</button>
              <button class="tiny" id="btnClassClear">Limpar</button>
            </span>
          </div>
          <select id="classSelect" multiple></select>
        </div>
        <div class="stack">
          <div class="label-actions">
            <label>Disciplinas (multi)</label>
            <span>
              <button class="tiny" id="btnDiscAll">Selecionar todos</button>
              <button class="tiny" id="btnDiscClear">Limpar</button>
            </span>
          </div>
          <select id="discSelect" multiple></select>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>Modo de barras</label>
          <select id="modeSelect">
            <option value="group">Agrupado</option>
            <option value="stack">Empilhado</option>
          </select>
        </div>
        <div class="stack">
          <label>Meta (% ≥6)</label>
          <input id="goalInput" type="number" min="0" max="100" step="1" placeholder="Ex.: 70" />
        </div>
      </div>

      <!-- Filtro de séries -->
      <div class="stack">
        <label>Séries (mostrar)</label>
        <div id="seriesFilter" class="toolbar compact">
          <label><input type="checkbox" data-series="M<5"> M&lt;5</label>
          <label><input type="checkbox" data-series="5≤M<6"> 5≤M&lt;6</label>
          <label><input type="checkbox" data-series="M≥6"> M≥6</label>
          <label><input type="checkbox" data-series="%<5"> %&lt;5</label>
          <label><input type="checkbox" data-series="5≤%<6"> 5≤%&lt;6</label>
          <label><input type="checkbox" data-series="%≥6"> %≥6</label>
        </div>
        <div class="mini">Dica: deixe ligado só o que deseja ver no gráfico.</div>
      </div>

      <div class="toolbar">
        <button id="btnPlot">Plotar seleção</button>
        <button id="btnDownload">Baixar PNG</button>
        <button id="btnExport">Exportar CSV</button>
      </div>
    </aside>

    <!-- onde vão o TOTAL + 1 gráfico por turma -->
    <section id="chartArea" class="charts"></section>
  </main>

<script>
// ================= Config & Paleta =================
const LABEL_MIN_PCT = 0.08; // rótulo só em %≥6 >= 8%
const COLORS = {
  'M<5'   : '#ef4444', '5≤M<6' : '#f59e0b', 'M≥6'   : '#22c55e',
  '%<5'   : '#fca5a5', '5≤%<6' : '#fbbf24', '%≥6'   : '#16a34a'
};

// ================= Estado =================
const state = {
  wb:null, sheet:null, dataBySheet:{}, columns:[],
  barmode:'group', goal:null, lastPlot:null,
  seriesFilter: { 'M<5': false, '5≤M<6': false, 'M≥6': true, '%<5': false, '5≤%<6': false, '%≥6': true },
  selectedBims: [], selectedClasses: [], selectedDiscs: []
};

const $ = (id)=>document.getElementById(id);
const setStatus = (msg) => $('status').textContent = msg;

// ================= Persistência =================
const saveState = ()=>{
  const payload = {
    barmode: state.barmode, goal: state.goal, series: state.seriesFilter,
    bims: state.selectedBims, classes: state.selectedClasses, discs: state.selectedDiscs
  };
  localStorage.setItem('dashboard@prefs', JSON.stringify(payload));
};
const loadState = ()=>{ try{ return JSON.parse(localStorage.getItem('dashboard@prefs')||'{}'); }catch{ return {}; } };

// ================= Utils =================
function toNumber(val, isPercent=false){
  if(val==null) return NaN;
  if(typeof val==='number') return isPercent? (val>1? val/100: val) : val;
  let s = String(val).trim(); if(!s) return NaN;
  const perc = /%/.test(s) || isPercent; s = s.replace(/%/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = Number(s); return Number.isNaN(n) ? NaN : (perc ? (n>1? n/100 : n) : n);
}
function uniqueValues(rows, key){
  const set=new Set();
  rows.forEach(r=>{ const v=r[key]; if(v!=null && String(v).trim()!=='') set.add(String(v)); });
  return Array.from(set);
}
function filterValidRows(rows, k){
  return rows.filter(r=>{ const x = String(r[k]??''); return x && !/(sub\s*total|total)/i.test(x); });
}
function sheetToJSON(sheetName){
  const ws = state.wb.Sheets[sheetName];
  const aoa = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:true });
  if(!aoa || !aoa.length){ state.dataBySheet[sheetName]=[]; state.columns=[]; return []; }
  let h=0; while(h<aoa.length && !aoa[h].some(v=>v!==null && v!=='')) h++;
  const header = (aoa[h]||[]).map((v,i)=> String(v??`col_${i}`).trim());
  const body = aoa.slice(h+1)
    .filter(r => r.some(v => v!==null && v!==''))
    .map(r => Object.fromEntries(header.map((k,i)=>[k, r[i] ?? null])));
  state.dataBySheet[sheetName] = body; state.columns = header;
  return body;
}
function getKeys(){
  const bimKey   = ['Bimestres','Bimestre'].find(k => state.columns.includes(k)) || null;
  const classKey = ['Série/Turma','Turma','Série','Classe'].find(k => state.columns.includes(k)) || null;
  return { bimKey, classKey };
}
function detectSubjects(){
  const s = new Set();
  state.columns.forEach(col => { const [l, r] = String(col).split('|'); if(l && r) s.add(l.trim()); });
  return Array.from(s);
}
function resolveCol(subject, kind){
  const norm = s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
  for(const c of state.columns){
    const parts = String(c).split('|'); const L = norm(parts[0]||''); const Rraw = parts.slice(1).join('|');
    if(!L.includes(norm(subject))) continue;
    if(kind==='pct_ge6'   && /(>=\s*6|\u2265\s*6|%≥6)/i.test(Rraw)) return c;
    if(kind==='qty'       && (/^qnt$|q(nt|uantidade)/i.test(Rraw))) return c;
    if(kind==='pct_lt5'   && /%<\s*5|%<5/i.test(Rraw)) return c;
    if(kind==='pct_5_6'   && /5\s*≤\s*%\s*<\s*6|5≤%<6/i.test(Rraw)) return c;
    if(kind==='band_mlt5' && /m\s*<\s*5|m<5/i.test(Rraw)) return c;
    if(kind==='band_5_6'  && /5\s*≤\s*m\s*<\s*6|5≤m<6/i.test(Rraw)) return c;
    if(kind==='band_mge6' && /m\s*≥\s*6|m≥6/i.test(Rraw)) return c;
  }
  return null;
}
function summarizeList(arr, maxLen=80){
  if(!arr || !arr.length) return 'Todas';
  const s = arr.join(', '); if(s.length<=maxLen) return s;
  const out=[]; let used=0;
  for(const v of arr){ const add=(out.length?2:0)+v.length; if(used+add>maxLen) break; out.push(v); used+=add; }
  return out.join(', ') + ` … (+${arr.length-out.length})`;
}

// ================= Agregação =================
function aggregateBySubject(rows, subject, bimKey, classKey, selectedBimsSet, classSet){
  const filtered = rows.filter(r=>{
    const okBim   = !bimKey || !selectedBimsSet || !selectedBimsSet.size ? true : selectedBimsSet.has(String(r[bimKey]));
    const okClass = !classKey || !classSet || !classSet.size ? true : classSet.has(String(r[classKey]));
    return okBim && okClass;
  });

  const cQ  = resolveCol(subject,'qty');
  const cB1 = resolveCol(subject,'band_mlt5');
  const cB2 = resolveCol(subject,'band_5_6');
  const cB3 = resolveCol(subject,'band_mge6');
  const cP1 = resolveCol(subject,'pct_lt5');
  const cP2 = resolveCol(subject,'pct_5_6');
  const cP3 = resolveCol(subject,'pct_ge6') || `${subject}|%≥6`;

  let sumQ=0,sumB1=0,sumB2=0,sumB3=0;
  let cntP1=0,cntP2=0,cntP3=0,avgP1=0,avgP2=0,avgP3=0;

  filtered.forEach(r=>{
    const q  = toNumber(cQ ? r[cQ] : null, false);
    const b1 = toNumber(cB1? r[cB1]: null, false);
    const b2 = toNumber(cB2? r[cB2]: null, false);
    const b3 = toNumber(cB3? r[cB3]: null, false);

    if(!Number.isNaN(b1)) sumB1+=b1;
    if(!Number.isNaN(b2)) sumB2+=b2;
    if(!Number.isNaN(b3)) sumB3+=b3;
    if(!Number.isNaN(q))  sumQ += q;

    const p1 = toNumber(cP1? r[cP1]: null, true);
    const p2 = toNumber(cP2? r[cP2]: null, true);
    const p3 = toNumber(cP3? r[cP3]: null, true);
    if(!Number.isNaN(p1)){ avgP1+=p1; cntP1++; }
    if(!Number.isNaN(p2)){ avgP2+=p2; cntP2++; }
    if(!Number.isNaN(p3)){ avgP3+=p3; cntP3++; }
  });

  const tot = sumQ>0 ? sumQ : (sumB1+sumB2+sumB3);
  let perc1,perc2,perc3;
  if(tot>0){
    perc1 = sumB1/tot; perc2 = sumB2/tot; perc3 = sumB3/tot;
  }else{
    perc1 = cntP1? (avgP1/cntP1) : NaN;
    perc2 = cntP2? (avgP2/cntP2) : NaN;
    perc3 = cntP3? (avgP3/cntP3) : NaN;
  }

  return { 'M<5':sumB1, '5≤M<6':sumB2, 'M≥6':sumB3, '%<5':perc1, '5≤%<6':perc2, '%≥6':perc3 };
}

// ================= Plot helpers (barras finas, gaps, legenda central) =================
function buildTracesAndLayout({subjects, classSet, selectedBims, headerText}){
  const rowsAll = state.dataBySheet[state.sheet];
  const { bimKey, classKey } = getKeys();

  const seriesLeft  = ['M<5','5≤M<6','M≥6'];
  const seriesRight = ['%<5','5≤%<6','%≥6'];
  const x = subjects.slice();
  const traces = [];

  const nSeries =
    seriesLeft.filter(s => state.seriesFilter[s]).length +
    seriesRight.filter(s => state.seriesFilter[s]).length || 1;

  const BAR_WIDTH = Math.min(0.55 / nSeries, 0.11);
  let groupIndex = 0; const nextGroup = () => String(groupIndex++);

  const fmtCount = v => (Number.isFinite(v) ? String(v) : '');
  const fmtPct   = v => (Number.isFinite(v) ? (v * 100).toFixed(1) + '%' : '');
  const bimSet   = new Set(selectedBims.map(String));

  // Y (quantidades)
  for (const sName of seriesLeft) {
    if (!state.seriesFilter[sName]) continue;
    const y = x.map(subj => aggregateBySubject(rowsAll, subj, bimKey, classKey, bimSet, classSet)[sName] || 0);
    traces.push({
      type:'bar', x, y, name:sName, yaxis:'y',
      offsetgroup: nextGroup(), alignmentgroup:'all', width:BAR_WIDTH,
      marker:{opacity:0.85,color:COLORS[sName],line:{width:0}},
      text:y.map(fmtCount), textposition:'outside', cliponaxis:false,
      hovertemplate:`%{x}<br>${sName}: %{y:d}<extra></extra>`,
      showlegend:true
    });
  }

  // Y2 (percentuais)
  const g = (state.goal != null && !Number.isNaN(state.goal)) ? Number(state.goal)/100 : null;
  for (const sName of seriesRight) {
    if (!state.seriesFilter[sName]) continue;
    const y = x.map(subj => aggregateBySubject(rowsAll, subj, bimKey, classKey, bimSet, classSet)[sName]);
    let marker = {opacity:0.95,color:COLORS[sName],line:{width:0}}; // cor fixa para %≥6; a meta é indicada só pela linha pontilhada
    traces.push({
      type:'bar', x, y, name:sName, yaxis:'y2',
      offsetgroup: nextGroup(), alignmentgroup:'all', width:BAR_WIDTH,
      marker, text:y.map(fmtPct), textposition:'outside', cliponaxis:false,
      hovertemplate:`%{x}<br>${sName}: %{y:.1%}<extra></extra>`,
      showlegend:true
    });
  }

  if (!traces.length) return {traces:[],layout:{}};

  const classesSummary = summarizeList(Array.from(classSet||[]));
  const shapes = [];
  if ((state.goal != null) && !Number.isNaN(state.goal)) {
    shapes.push({type:'line',xref:'paper',x0:0,x1:1,yref:'y2',y0:Number(state.goal)/100,y1:Number(state.goal)/100,
      line:{color:'#ef4444',width:2,dash:'dot'}});
  }

  const layout = {
    title: { text: headerText, x:0.5, xanchor:'center', pad:{t:6} },
    barmode: state.barmode,
    bargap: 0.30, bargroupgap: 0.35,
    font:{ color:'#e2e8f0' },
    paper_bgcolor:'transparent', plot_bgcolor:'transparent',
    hovermode:'x unified',
    xaxis:{ gridcolor:'#1f2a44', title:'Disciplinas', automargin:true },
    yaxis:{ gridcolor:'#1f2a44', title:'Quantidade', automargin:true },
    yaxis2:{ overlaying:'y', side:'right', tickformat:'.0%', range:[0,1], title:'Percentual', showgrid:false },
    showlegend:true,
    legend:{ orientation:'h', x:0.5, xanchor:'center', y:-0.24, yanchor:'top', tracegroupgap:12, font:{size:12} },
    margin:{ l:60, r:60, t:80, b:110 },
    annotations:[{ xref:'paper', yref:'paper', x:0.5, y:1.08, showarrow:false,
      text:`<span style="color:#94a3b8"><b>Série/Turma:</b> ${classesSummary}</span>`,
      xanchor:'center', align:'center'}],
    shapes
  };

  return { traces, layout };
}

// ============== Plot principal: TOTAL + 1 gráfico por turma selecionada ==============
function plotMultiPanels(){
  const rowsAll = state.dataBySheet[state.sheet];
  if(!rowsAll) return alert('Planilha não carregada.');
  const { bimKey, classKey } = getKeys();
  const selectedBims = state.selectedBims;
  if(!selectedBims.length) return alert('Escolha ao menos um Bimestre.');
  const subjects = state.selectedDiscs.length ? state.selectedDiscs : detectSubjects();
  if(!subjects.length) return alert('Selecione ao menos uma disciplina.');

  // limpa área e cria os contêineres
  const area = $('chartArea'); area.innerHTML = '';

  // 1) TOTAL (somando as turmas selecionadas)
  const totalSet = new Set(state.selectedClasses.map(String)); // pode estar vazio => soma todas
  const totalBox = document.createElement('div'); totalBox.className='chartBox'; totalBox.id='chartTotal';
  area.appendChild(totalBox);
  const {traces:trT, layout:lyT} =
    buildTracesAndLayout({subjects, classSet: totalSet, selectedBims, headerText:`Bimestres: ${selectedBims.join(', ')} — TOTAL`});
  if(!trT.length) return alert('Todos os filtros de séries estão desligados. Marque ao menos um.');
  Plotly.newPlot(totalBox, trT, lyT, {responsive:true, displaylogo:false});

  // 2) Um gráfico POR turma selecionada
  const classes = state.selectedClasses.length ? state.selectedClasses.slice() :
                  (classKey ? uniqueValues(rowsAll, classKey).sort() : []);
  for(const turma of classes){
    const classSet = new Set([String(turma)]);
    const box = document.createElement('div'); box.className='chartBox';
    box.id = 'chart_'+String(turma).replace(/\W+/g,'_');
    area.appendChild(box);

    const {traces, layout} =
      buildTracesAndLayout({subjects, classSet, selectedBims, headerText:`Bimestres: ${selectedBims.join(', ')} — ${turma}`});
    Plotly.newPlot(box, traces, layout, {responsive:true, displaylogo:false});
  }

  state.lastPlot = { type:'panels', bims:selectedBims.slice(), discs:subjects.slice(), classes:state.selectedClasses.slice() };
  saveState();
}
window.plotMultiByDiscipline = plotMultiPanels; // mantém compatível com chamadas antigas

// ================= Export CSV (agregado por bimestre/disciplinas, total) =================
function exportCSV(){
  const rowsAll = state.dataBySheet[state.sheet];
  if(!rowsAll) return alert('Planilha não carregada.');
  const { bimKey, classKey } = getKeys();
  if(!bimKey) return alert('Coluna de Bimestre não encontrada.');
  const selectedBims = state.selectedBims.length ? state.selectedBims : uniqueValues(rowsAll, bimKey);
  const discs = state.selectedDiscs.length ? state.selectedDiscs : detectSubjects();
  const classSet = new Set(state.selectedClasses.map(String));

  const headers = ['Bimestre','Disciplina','M<5','5≤M<6','M≥6','%<5','5≤%<6','%≥6'];
  const lines = [headers.join(',')];

  for(const b of selectedBims){
    const bimSet = new Set([String(b)]);
    for(const subj of discs){
      const agg = aggregateBySubject(rowsAll, subj, bimKey, classKey, bimSet, classSet);
      const row = [
        b, subj,
        (agg['M<5']||0),(agg['5≤M<6']||0),(agg['M≥6']||0),
        Number.isFinite(agg['%<5'])?(agg['%<5']*100).toFixed(1)+'%':'',
        Number.isFinite(agg['5≤%<6'])?(agg['5≤%<6']*100).toFixed(1)+'%':'',
        Number.isFinite(agg['%≥6'])?(agg['%≥6']*100).toFixed(1)+'%':''
      ];
      lines.push(row.join(','));
    }
  }
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='dados_total.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ================= Inicialização =================
async function init(){
  try{
    const res = await fetch('data/Bimestral.xlsx');
    if(!res.ok) throw new Error('Erro '+res.status+' ao carregar data/Bimestral.xlsx');
    const ab = await res.arrayBuffer(); state.wb = XLSX.read(ab,{type:'array'});

    state.sheet = state.wb.SheetNames[0];
    const rows = sheetToJSON(state.sheet);
    const { bimKey, classKey } = getKeys();

    // Bimestres
    const bims = bimKey ? uniqueValues(filterValidRows(rows, bimKey), bimKey) : [];
    const selBim = $('bimSelect'); selBim.innerHTML='';
    bims.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selBim.appendChild(o); });

    // Classes (todas inicialmente)
    const classes = classKey ? uniqueValues(rows, classKey).sort() : [];
    const selClass = $('classSelect'); selClass.innerHTML='';
    classes.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; selClass.appendChild(o); });

    // Disciplinas
    const discs = detectSubjects();
    const selDisc = $('discSelect'); selDisc.innerHTML='';
    discs.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; selDisc.appendChild(o); });

    // Prefs
    const prefs = loadState();
    state.barmode = (prefs.barmode==='stack')? 'stack':'group';
    $('modeSelect').value = state.barmode;
    state.goal = (prefs.goal!=null)? prefs.goal : null; if(state.goal!=null) $('goalInput').value = state.goal;
    if (prefs.series) state.seriesFilter = {...state.seriesFilter, ...prefs.series};
    document.querySelectorAll('#seriesFilter input[data-series]').forEach(chk=>{
      chk.checked = !!state.seriesFilter[chk.getAttribute('data-series')];
    });
    const keep = (arr,pool)=> Array.isArray(arr)? arr.filter(v=>pool.includes(v)):[];
    state.selectedBims    = keep(prefs.bims, bims);
    state.selectedClasses = keep(prefs.classes, classes);
    state.selectedDiscs   = keep(prefs.discs, discs);
    for(const o of selBim.options)   o.selected = state.selectedBims.includes(o.value);
    for(const o of selClass.options) o.selected = state.selectedClasses.includes(o.value);
    for(const o of selDisc.options)  o.selected = state.selectedDiscs.includes(o.value);

    setStatus(`Aba: ${state.sheet} | Bimestres: ${bims.join(', ')}`);
  }catch(e){
    setStatus('Falha ao carregar planilha: '+e.message);
    console.error(e);
  }
}

// ================= Ligações UI =================
document.addEventListener('DOMContentLoaded', ()=>{
  const readMulti = (sel)=> Array.from(sel.selectedOptions).map(o=>o.value);
  const selectAll = (sel)=> { for(const o of sel.options) o.selected = true; sel.dispatchEvent(new Event('change')); };
  const clearAll  = (sel)=> { for(const o of sel.options) o.selected = false; sel.dispatchEvent(new Event('change')); };

  $('bimSelect').addEventListener('change', ()=>{ state.selectedBims = readMulti($('bimSelect')); saveState(); });
  $('classSelect').addEventListener('change', ()=>{ state.selectedClasses = readMulti($('classSelect')); saveState(); });
  $('discSelect').addEventListener('change', ()=>{ state.selectedDiscs = readMulti($('discSelect')); saveState(); });

  $('btnBimAll').addEventListener('click', ()=> selectAll($('bimSelect')));
  $('btnBimClear').addEventListener('click', ()=> clearAll($('bimSelect')));
  $('btnClassAll').addEventListener('click', ()=> selectAll($('classSelect')));
  $('btnClassClear').addEventListener('click', ()=> clearAll($('classSelect')));
  $('btnDiscAll').addEventListener('click', ()=> selectAll($('discSelect')));
  $('btnDiscClear').addEventListener('click', ()=> clearAll($('discSelect')));

  $('modeSelect').addEventListener('change', ()=>{ state.barmode=$('modeSelect').value; saveState(); if(state.lastPlot) plotMultiPanels(); });
  $('goalInput').addEventListener('input', ()=>{ const v=Number($('goalInput').value); state.goal = Number.isFinite(v)? v : null; saveState(); if(state.lastPlot) plotMultiPanels(); });

  document.querySelectorAll('#seriesFilter input[data-series]').forEach(chk=>{
    chk.addEventListener('change', ()=>{
      state.seriesFilter[chk.getAttribute('data-series')] = chk.checked;
      saveState();
      if (state.lastPlot) plotMultiPanels();
    });
  });

  $('btnPlot').addEventListener('click', plotMultiPanels);

  // baixa o PNG do gráfico TOTAL
  $('btnDownload').addEventListener('click', ()=>{
    const el = document.getElementById('chartTotal') || document.querySelector('.chartBox');
    if(!el){ alert('Plote um gráfico primeiro.'); return; }
    Plotly.downloadImage(el, {format:'png', filename:'dashboard_total'});
  });

  $('btnExport').addEventListener('click', exportCSV);

  init();
});
</script>
</body>
</html>
