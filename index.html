<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Excel → Gráficos Interativos (GitHub Pages)</title>
  <style>
    :root{--bg:#0f172a;--panel:#0b1428;--stroke:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--brand:#0284c7;--ok:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    header{padding:12px 16px;border-bottom:1px solid var(--stroke);display:flex;gap:12px;align-items:center}
    .container{max-width:1280px;margin:0 auto;padding:0 12px;width:100%}
    main{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}
    aside{background:linear-gradient(180deg,#0f172a,#0b1325);border:1px solid var(--stroke);border-radius:12px;padding:12px}
    label{font-size:12px;color:var(--muted)}
    select,input[type="number"],button{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #264161;background:#0b1b34;color:var(--text)}
    select[multiple]{height:220px}
    button{cursor:pointer;background:var(--brand);border-color:#0ea5e9;font-weight:600}
    button.secondary{background:#1e293b;border:1px solid #64748b}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stack{display:grid;gap:8px}
    #chartHost{width:100%;height:560px;margin:0 auto;border:1px solid var(--stroke);border-radius:12px;background:linear-gradient(180deg,#0f172a,#0b1325)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .toolbar.compact label{
      display:flex; align-items:center; gap:6px;
      background:transparent; padding:4px 6px; border-radius:6px;
      border:1px solid var(--stroke);
    }
    .toolbar.compact input{ width:auto; }
    .mini{font-size:12px;opacity:.8}
  </style>
  <noscript>
    <style>main{display:none}</style>
    <div>Este dashboard precisa de JavaScript habilitado.</div>
  </noscript>
  <!-- Bibliotecas locais -->
  <script src="vendor/xlsx.full.min.js"></script>
  <script src="vendor/plotly-2.35.2.min.js"></script>
</head>
<body>
  <header class="container">
    <div style="font-weight:700">Disciplinas Detalhadas — Dashboard</div>
    <div id="status" style="margin-left:auto;font-size:12px;opacity:.85"></div>
  </header>

  <main class="container">
    <aside class="stack">
      <div class="stack">
        <label>Planilha (aba)</label>
        <select id="sheetSelect"></select>
      </div>

      <!-- Filtros iguais ao print: Série/Turma e Disciplinas (multi-seleção) -->
      <div class="row">
        <div class="stack">
          <label>Série/Turma (multi)</label>
          <select id="classSelect" multiple></select>
        </div>
        <div class="stack">
          <label>Disciplinas (multi)</label>
          <select id="discSelect" multiple></select>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>Modo de barras</label>
          <select id="modeSelect">
            <option value="group">Agrupado</option>
            <option value="stack">Empilhado</option>
          </select>
        </div>
        <div class="stack">
          <label>Meta (% ≥6)</label>
          <input id="goalInput" type="number" min="0" max="100" step="1" placeholder="Ex.: 70" />
        </div>
      </div>

      <!-- Filtro de séries (quais barras mostrar) -->
      <div class="stack">
        <label>Séries (mostrar)</label>
        <div id="seriesFilter" class="toolbar compact">
          <label><input type="checkbox" data-series="M<5"> M&lt;5</label>
          <label><input type="checkbox" data-series="5≤M<6"> 5≤M&lt;6</label>
          <label><input type="checkbox" data-series="M≥6"> M≥6</label>
          <label><input type="checkbox" data-series="%<5"> %&lt;5</label>
          <label><input type="checkbox" data-series="5≤%<6"> 5≤%&lt;6</label>
          <label><input type="checkbox" data-series="%≥6"> %≥6</label>
        </div>
        <div class="mini">Dica: marque apenas o que deseja ver no gráfico.</div>
      </div>

      <div class="toolbar">
        <button id="btnPlot">Plotar seleção</button>
        <button id="btnDownload">Baixar PNG</button>
        <button id="btnExport">Exportar CSV</button>
      </div>
    </aside>

    <section id="chartHost"></section>
  </main>

<script>
// ===== Config visual mínima =====
const LABEL_MIN_PCT = 0.08;  // rótulo só para %≥6 >= 8%

// ===== Estado =====
const state = {
  wb:null, sheet:null, dataBySheet:{}, columns:[],
  barmode:'group', goal:null, lastPlot:null,
  // filtro padrão: mostrar M≥6 e %≥6; demais ocultas
  seriesFilter: { 'M<5': false, '5≤M<6': false, 'M≥6': true, '%<5': false, '5≤%<6': false, '%≥6': true },
  selectedClasses: [],   // valores em "Série/Turma"
  selectedDiscs: []      // disciplinas selecionadas
};
const $ = (id)=>document.getElementById(id);
const setStatus = (msg) => $('status').textContent = msg;

// ===== Persistência =====
const saveState = ()=>{
  const payload = {
    sheet: state.sheet, barmode: state.barmode, goal: state.goal,
    series: state.seriesFilter, classes: state.selectedClasses, discs: state.selectedDiscs
  };
  localStorage.setItem('dashboard@prefs', JSON.stringify(payload));
};
const loadState = ()=>{
  try{ return JSON.parse(localStorage.getItem('dashboard@prefs')||'{}'); }catch{ return {}; }
};

// ===== Utils =====
function toNumber(val, isPercent=false){
  if(val==null) return NaN;
  if(typeof val==='number') return isPercent? (val>1? val/100: val) : val;
  let s = String(val).trim(); if(!s) return NaN;
  const perc = /%/.test(s) || isPercent; s = s.replace(/%/g,'').replace(/\./g,'').replace(/,/g,'.');
  let n = Number(s);
  return Number.isNaN(n) ? NaN : (perc ? (n>1? n/100 : n) : n);
}
function uniqueValues(rows, key){
  const set=new Set();
  for(const r of rows){ const v=r[key]; if(v!=null && String(v).trim()!=='') set.add(String(v)); }
  return Array.from(set);
}
function filterValidRows(rows, xKey){
  return rows.filter(r=>{ const x = String(r[xKey]??''); return x && !/(sub\s*total|total)/i.test(x); });
}
function sheetToJSON(sheetName){
  const ws = state.wb.Sheets[sheetName];
  const aoa = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:true });
  if(!aoa || !aoa.length){ state.dataBySheet[sheetName]=[]; state.columns=[]; return []; }
  let h=0; while(h<aoa.length && !aoa[h].some(v=>v!==null && v!=='')) h++;
  const header = (aoa[h]||[]).map((v,i)=> String(v??`col_${i}`).trim());
  const body = aoa.slice(h+1)
    .filter(r => r.some(v => v!==null && v!==''))
    .map(r => Object.fromEntries(header.map((k,i)=>[k, r[i] ?? null])));
  state.dataBySheet[sheetName] = body; state.columns = header; return body;
}
function pickX(rows){
  if(!rows.length) return null; const keys = Object.keys(rows[0]||{});
  const pref = ['Série/Turma','Bimestres','Bimestre','Turma','Série','Classe'];
  for(const k of pref){ if(keys.includes(k)) return k; }
  return keys[0] || null;
}
function detectSubjects(){
  const subj = new Set();
  for(const col of state.columns){
    const [left, right] = String(col).split('|');
    if(left && right) subj.add(left.trim());
  }
  return Array.from(subj);
}
function resolveCol(subject, kind){
  const norm = s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
  const candidates = state.columns;
  for(const c of candidates){
    const parts = String(c).split('|'); const L = norm(parts[0]||''); const Rraw = parts.slice(1).join('|');
    if(!L) continue; if(!L.includes(norm(subject))) continue;
    if(kind==='pct_ge6'   && /(>=\s*6|\u2265\s*6|%≥6)/i.test(Rraw)) return c;
    if(kind==='qty'       && (/^qnt$|q(nt|uantidade)/i.test(Rraw))) return c;
    if(kind==='pct_lt5'   && /%<\s*5|%<5/i.test(Rraw)) return c;
    if(kind==='pct_5_6'   && /5\s*≤\s*%\s*<\s*6|5≤%<6/i.test(Rraw)) return c;
    if(kind==='band_mlt5' && /m\s*<\s*5|m<5/i.test(Rraw)) return c;
    if(kind==='band_5_6'  && /5\s*≤\s*m\s*<\s*6|5≤m<6/i.test(Rraw)) return c;
    if(kind==='band_mge6' && /m\s*≥\s*6|m≥6/i.test(Rraw)) return c;
  }
  return null;
}

// ===== Agregação por disciplina, com filtro opcional de turmas =====
function aggregateBySubject(rows, subject, classKey, classFilterSet){
  // aplica filtro de classes (se houver)
  const rFiltered = classKey && classFilterSet && classFilterSet.size
    ? rows.filter(r => classFilterSet.has(String(r[classKey])))
    : rows.slice();

  const cQ  = resolveCol(subject,'qty');
  const cB1 = resolveCol(subject,'band_mlt5');
  const cB2 = resolveCol(subject,'band_5_6');
  const cB3 = resolveCol(subject,'band_mge6');
  const cP1 = resolveCol(subject,'pct_lt5');
  const cP2 = resolveCol(subject,'pct_5_6');
  const cP3 = resolveCol(subject,'pct_ge6') || `${subject}|%≥6`;

  let sumQ=0,sumB1=0,sumB2=0,sumB3=0;
  let cntP1=0,cntP2=0,cntP3=0,avgP1=0,avgP2=0,avgP3=0;

  for(const r of rFiltered){
    const q  = toNumber(cQ ? r[cQ] : null, false);
    const b1 = toNumber(cB1? r[cB1]: null, false);
    const b2 = toNumber(cB2? r[cB2]: null, false);
    const b3 = toNumber(cB3? r[cB3]: null, false);

    // soma bandas/quantidade
    if(!Number.isNaN(b1)) sumB1+=b1;
    if(!Number.isNaN(b2)) sumB2+=b2;
    if(!Number.isNaN(b3)) sumB3+=b3;
    if(!Number.isNaN(q))  sumQ += q;

    // média simples para % (fallback se não houver contagem)
    const p1 = toNumber(cP1? r[cP1]: null, true);
    const p2 = toNumber(cP2? r[cP2]: null, true);
    const p3 = toNumber(cP3? r[cP3]: null, true);
    if(!Number.isNaN(p1)){ avgP1+=p1; cntP1++; }
    if(!Number.isNaN(p2)){ avgP2+=p2; cntP2++; }
    if(!Number.isNaN(p3)){ avgP3+=p3; cntP3++; }
  }

  // calcula % a partir das contagens (preferível)
  const tot = sumQ>0 ? sumQ : (sumB1+sumB2+sumB3);
  let perc1,perc2,perc3;
  if(tot>0){
    perc1 = sumB1/tot; perc2 = sumB2/tot; perc3 = sumB3/tot;
  }else{
    perc1 = cntP1? (avgP1/cntP1) : NaN;
    perc2 = cntP2? (avgP2/cntP2) : NaN;
    perc3 = cntP3? (avgP3/cntP3) : NaN;
  }

  return { 'M<5':sumB1, '5≤M<6':sumB2, 'M≥6':sumB3, '%<5':perc1, '5≤%<6':perc2, '%≥6':perc3 };
}

// ===== Plot múltiplas disciplinas → 6 barras por disciplina =====
function plotMultiByDiscipline(){
  const rowsAll = state.dataBySheet[state.sheet] || sheetToJSON(state.sheet);
  const classKey = ['Série/Turma','Turma','Série','Classe'].find(k => state.columns.includes(k)) || null;
  const xKey = pickX(rowsAll);
  const rows = filterValidRows(rowsAll, xKey);

  const discs = state.selectedDiscs.length ? state.selectedDiscs : detectSubjects();
  if(!discs.length) return alert('Selecione pelo menos 1 disciplina.');
  const classSet = new Set(state.selectedClasses.map(String));

  // prepara arrays por série
  const seriesNamesLeft  = ['M<5','5≤M<6','M≥6'];   // y
  const seriesNamesRight = ['%<5','5≤%<6','%≥6'];   // y2
  const x = discs.slice(); // disciplinas no eixo X

  const traces=[];

  // LEFT (quantidades)
  for(const sName of seriesNamesLeft){
    if(!state.seriesFilter[sName]) continue;
    const y = discs.map(subj => aggregateBySubject(rows, subj, classKey, classSet)[sName] || 0);
    traces.push({
      type:'bar', x, y, name:sName, yaxis:'y', marker:{opacity:0.75},
      hovertemplate: '%{x}<br>'+sName+': %{y:d}<extra></extra>'
    });
  }

  // RIGHT (percentuais)
  const labelIf = (name, yArr) => yArr.map(v => (name==='%≥6' && v>=LABEL_MIN_PCT) ? (v*100).toFixed(1)+'%' : '');
  for(const sName of seriesNamesRight){
    if(!state.seriesFilter[sName]) continue;
    const y = discs.map(subj => aggregateBySubject(rows, subj, classKey, classSet)[sName]);
    traces.push({
      type:'bar', x, y, name:sName, yaxis:'y2',
      text: labelIf(sName, y), textposition:'outside',
      hovertemplate: '%{x}<br>'+sName+': %{y:.1%}<extra></extra>'
    });
  }

  if(!traces.length) return alert('Todos os filtros de séries estão desligados. Marque pelo menos 1.');

  const shapes=[];
  if(state.goal!=null && !Number.isNaN(state.goal)){
    const g = Number(state.goal)/100;
    shapes.push({type:'line',xref:'paper',x0:0,x1:1,yref:'y2',y0:g,y1:g,line:{color:'#ef4444',width:2,dash:'dot'}});
  }

  const layout = {
    title: 'Disciplinas selecionadas',
    barmode: state.barmode,
    bargap: 0.2, // barras mais finas
    font:{color:'#e2e8f0'},
    paper_bgcolor:'transparent', plot_bgcolor:'transparent',
    hovermode:'x unified',
    xaxis:{ gridcolor:'#1f2a44', title:'Disciplinas', automargin:true },
    yaxis:{ gridcolor:'#1f2a44', title:'Quantidade', automargin:true },
    yaxis2:{ overlaying:'y', side:'right', tickformat:'.0%', range:[0,1], title:'Percentual', showgrid:false },
    legend:{orientation:'h', x:0, y:1.12, tracegroupgap:12},
    margin:{l:60,r:60,t:60,b:60},
    shapes
  };

  Plotly.newPlot('chartHost', traces, layout, {responsive:true, displaylogo:false});
  state.lastPlot = { type:'multi-disc', discs, classKey };
  saveState();
}
window.plotMultiByDiscipline = plotMultiByDiscipline; // para chamar de qualquer lugar

// ===== Export / Download (mantive simples) =====
function downloadPNG(){ Plotly.downloadImage('chartHost',{format:'png',filename:'dashboard'}); }
function exportCSV(){ alert('Exportação CSV para este modo pode ser adicionada sob demanda.'); }

// ===== Inicialização + Ligações =====
async function init(){
  try{
    const res = await fetch('data/Bimestral.xlsx');
    if(!res.ok) throw new Error('Erro '+res.status+' ao carregar data/Bimestral.xlsx');
    const ab = await res.arrayBuffer(); state.wb = XLSX.read(ab, { type:'array' });

    // popula select de abas
    const selSheet = $('sheetSelect'); selSheet.innerHTML='';
    state.wb.SheetNames.forEach(name => { const o=document.createElement('option'); o.value=name; o.textContent=name; selSheet.appendChild(o); });

    // restaura preferências
    const prefs = loadState();
    state.sheet = prefs.sheet && state.wb.SheetNames.includes(prefs.sheet) ? prefs.sheet : state.wb.SheetNames[0];
    selSheet.value = state.sheet;

    // carrega dados da aba
    const rows = sheetToJSON(state.sheet);
    const xKey = pickX(rows);

    // popula Série/Turma (ou fallback)
    const classKey = ['Série/Turma','Turma','Série','Classe'].find(k => state.columns.includes(k)) || xKey;
    const classes = uniqueValues(filterValidRows(rows, xKey), classKey).sort();
    const selClass = $('classSelect'); selClass.innerHTML='';
    classes.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; selClass.appendChild(o); });

    // popula Disciplinas (do cabeçalho)
    const discs = detectSubjects();
    const selDisc = $('discSelect'); selDisc.innerHTML='';
    discs.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; selDisc.appendChild(o); });

    // barmode/meta
    state.barmode = (prefs.barmode==='stack')? 'stack':'group';
    $('modeSelect').value = state.barmode;
    state.goal = (prefs.goal!=null)? prefs.goal : null;
    if(state.goal!=null) $('goalInput').value=state.goal;

    // filtro de séries (restaura)
    if (prefs.series && typeof prefs.series === 'object') {
      state.seriesFilter = { ...state.seriesFilter, ...prefs.series };
    }
    document.querySelectorAll('#seriesFilter input[data-series]').forEach(chk=>{
      const key = chk.getAttribute('data-series');
      chk.checked = !!state.seriesFilter[key];
    });

    // restaura seleções multi
    if (Array.isArray(prefs.classes)) {
      state.selectedClasses = prefs.classes.filter(v => classes.includes(v));
      for (const opt of selClass.options) opt.selected = state.selectedClasses.includes(opt.value);
    }
    if (Array.isArray(prefs.discs)) {
      state.selectedDiscs = prefs.discs.filter(v => discs.includes(v));
      for (const opt of selDisc.options) opt.selected = state.selectedDiscs.includes(opt.value);
    }

    setStatus(`Aba: ${state.sheet} | Colunas: ${state.columns.slice(0,6).join(', ')}${state.columns.length>6?'…':''}`);
  }catch(e){
    setStatus('Falha ao carregar planilha: '+e.message); console.error(e);
  }
}

// liga UI
document.addEventListener('DOMContentLoaded', () => {
  // troca de aba
  $('sheetSelect').addEventListener('change',()=>{
    state.sheet=$('sheetSelect').value; sheetToJSON(state.sheet); saveState();
  });

  // modos/meta
  $('modeSelect').addEventListener('change',()=>{ state.barmode=$('modeSelect').value; saveState(); });
  $('goalInput').addEventListener('input',()=>{ const v=Number($('goalInput').value); state.goal = Number.isFinite(v)? v : null; saveState(); });

  // séries (checkboxes)
  document.querySelectorAll('#seriesFilter input[data-series]').forEach(chk=>{
    chk.addEventListener('change', ()=>{
      const key = chk.getAttribute('data-series');
      state.seriesFilter[key] = chk.checked;
      saveState();
      if (state.lastPlot && state.lastPlot.type === 'multi-disc') plotMultiByDiscipline();
    });
  });

  // seleção múltipla (classes e disciplinas)
  const readMulti = (sel)=> Array.from(sel.selectedOptions).map(o=>o.value);
  $('classSelect').addEventListener('change', ()=>{
    state.selectedClasses = readMulti($('classSelect')); saveState();
  });
  $('discSelect').addEventListener('change', ()=>{
    state.selectedDiscs = readMulti($('discSelect')); saveState();
  });

  // ações
  $('btnPlot').addEventListener('click', plotMultiByDiscipline);
  $('btnDownload').addEventListener('click', downloadPNG);
  $('btnExport').addEventListener('click', exportCSV);

  init();
});
</script>
</body>
</html>
