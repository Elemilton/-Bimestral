<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Excel → Gráficos Interativos (GitHub Pages)</title>
  <style>
    body{background:#0f172a;color:#e2e8f0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    header{padding:12px 16px;border-bottom:1px solid #1e293b;display:flex;gap:8px;align-items:center}
    button{margin:6px 8px;padding:8px 12px;border-radius:10px;border:1px solid #0ea5e9;background:#0284c7;color:white;cursor:pointer}
    button.secondary{background:#1e293b;border:1px solid #64748b;color:#e2e8f0}
    #chartHost{width:100%;height:520px;margin:16px auto}
    .container{max-width:1200px;margin:0 auto;padding:0 12px}
  </style>
  <noscript>
    <style>main{display:none}</style>
    <div>Este dashboard precisa de JavaScript habilitado.</div>
  </noscript>
  <!-- Bibliotecas locais -->
  <script src="vendor/xlsx.full.min.js"></script>
  <script src="vendor/plotly-2.35.2.min.js"></script>
</head>
<body>
  <header class="container">
    <div style="font-weight:700">Gran Cursos Online</div>
    <div id="status" style="margin-left:auto;font-size:12px;opacity:.8"></div>
  </header>
  <main class="container">
    <div>
      <button id="btnMath">Plotar Matemática</button>
      <button id="btnPort">Plotar Português</button>
      <button id="btnCompare">Comparar Matemática × Português</button>
      <span style="margin-left:16px;opacity:.85">Detalhado:</span>
      <button id="btnBioDet" class="secondary">Biologia (Qnt + faixas + %)</button>
      <button id="btnMatDet" class="secondary">Matemática (Qnt + faixas + %)</button>
      <button id="btnPorDet" class="secondary">Português (Qnt + faixas + %)</button>
    </div>
    <div id="chartHost"></div>
  </main>

  <script>
  const state = { wb:null, firstSheet:null, dataBySheet:{}, columns:[] };
  const setStatus = (msg) => document.getElementById('status').textContent = msg;

  function toNumber(val, isPercent=false){
    if(val==null) return NaN;
    if(typeof val==='number') return isPercent? (val>1? val/100: val) : val;
    let s = String(val).trim();
    if(!s) return NaN;
    const perc = /%/.test(s) || isPercent;
    s = s.replace(/%/g,'').replace(/\./g,'').replace(/,/g,'.');
    let n = Number(s);
    if(Number.isNaN(n)) return NaN;
    return perc ? (n>1? n/100 : n) : n;
  }
  function filterValidRows(rows, xKey){
    return rows.filter(r=>{
      const x = String(r[xKey]??'');
      return x && !/(sub\s*total|total)/i.test(x);
    });
  }

  function sheetToJSON(sheetName){
    const ws = state.wb.Sheets[sheetName];
    const aoa = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:true });
    if(!aoa || !aoa.length){ state.dataBySheet[sheetName]=[]; state.columns=[]; return []; }
    let h=0; while(h<aoa.length && !aoa[h].some(v=>v!==null && v!=='')) h++;
    const header = (aoa[h]||[]).map((v,i)=> String(v??`col_${i}`).trim());
    const body = aoa.slice(h+1)
      .filter(r => r.some(v => v!==null && v!==''))
      .map(r => Object.fromEntries(header.map((k,i)=>[k, r[i] ?? null])));
    state.dataBySheet[sheetName] = body;
    state.columns = header;
    return body;
  }

  function pickX(rows){
    if(!rows.length) return null;
    const keys = Object.keys(rows[0]||{});
    const pref = ['Bimestres','Bimestre','Série/Turma','Turma','Série','Classe'];
    for(const k of pref){ if(keys.includes(k)) return k; }
    return keys[0] || null;
  }

  function plotCustom(sheetName, yCol){
    const rowsAll = state.dataBySheet[sheetName] || sheetToJSON(sheetName);
    const xKey = pickX(rowsAll); if(!xKey) return alert('Não encontrei coluna para eixo X.');
    const rows = filterValidRows(rowsAll, xKey);
    if(!state.columns.includes(yCol)) return alert('Coluna não encontrada: '+yCol);

    const pairs=[]; for(const r of rows){ const y=toNumber(r[yCol], true); if(!isNaN(y)) pairs.push({x:r[xKey], y}); }
    const x = pairs.map(p=>p.x), y = pairs.map(p=>p.y);

    const trace = {
      type:'bar', x, y, name:yCol, marker:{color:'#3b82f6'},
      text: y.map(v => (v*100).toFixed(1) + '%'), textposition:'outside'
    };
    const layout = {
      title: yCol, font:{color:'#e2e8f0'},
      paper_bgcolor:'transparent', plot_bgcolor:'transparent',
      xaxis:{ gridcolor:'#1f2a44', title:xKey },
      yaxis:{ gridcolor:'#1f2a44', tickformat:'.0%', range:[0,1], title:'% ≥6' }
    };
    Plotly.newPlot('chartHost', [trace], layout, {responsive:true, displaylogo:false});
  }

  function plotCompare(sheetName, yColA, yColB){
    const rowsAll = state.dataBySheet[sheetName] || sheetToJSON(sheetName);
    const xKey = pickX(rowsAll); if(!xKey) return alert('Não encontrei coluna para eixo X.');
    const rows = filterValidRows(rowsAll, xKey);
    if(!state.columns.includes(yColA) || !state.columns.includes(yColB)){
      return alert('Colunas não encontradas: '+yColA+' e/ou '+yColB);
    }
    const x=[], yA=[], yB=[];
    for(const r of rows){
      const a = toNumber(r[yColA], true), b = toNumber(r[yColB], true);
      if(!isNaN(a) && !isNaN(b)){ x.push(r[xKey]); yA.push(a); yB.push(b); }
    }
    const traces = [
      {type:'bar', x, y:yA, name:yColA, marker:{color:'#3b82f6'}, text: yA.map(v=>(v*100).toFixed(1)+'%'), textposition:'outside'},
      {type:'bar', x, y:yB, name:yColB, marker:{color:'#f59e0b'}, text: yB.map(v=>(v*100).toFixed(1)+'%'), textposition:'outside'}
    ];
    const layout = {
      barmode:'group',
      title:`${yColA} × ${yColB}`, font:{color:'#e2e8f0'},
      paper_bgcolor:'transparent', plot_bgcolor:'transparent',
      xaxis:{ gridcolor:'#1f2a44', title:xKey },
      yaxis:{ gridcolor:'#1f2a44', tickformat:'.0%', range:[0,1], title:'% ≥6' }
    };
    Plotly.newPlot('chartHost', traces, layout, {responsive:true, displaylogo:false});
  }

  // ====== PLOT DETALHADO (Qnt + faixas + % com eixo secundário) ======
  function plotSubjectDetailed(sheetName, subject){
    const rowsAll = state.dataBySheet[sheetName] || sheetToJSON(sheetName);
    const xKey = pickX(rowsAll); if(!xKey) return alert('Não encontrei coluna para eixo X.');
    const rows = filterValidRows(rowsAll, xKey);

    const cols = new Set(state.columns.map(c => String(c)));
    const has = (name) => Array.from(cols).some(c => c.toLowerCase() === name.toLowerCase());

    const qntKey   = has('Qnt') ? 'Qnt' : Array.from(cols).find(c => new RegExp(`^${subject}\\|?qnt$`, 'i').test(c));
    const bandKeys = [`${subject}|M<5`, `${subject}|5≤M<6`, `${subject}|M≥6`].filter(has);
    const percKeys = [`${subject}|%<5`, `${subject}|5≤%<6`, `${subject}|%≥6`].filter(has);

    const x = rows.map(r => r[xKey]);
    const traces = [];

    if(qntKey){
      const y = rows.map(r => toNumber(r[qntKey], false));
      traces.push({ type:'bar', x, y, name:'Qnt', yaxis:'y' });
    }

    bandKeys.forEach(col => {
      const y = rows.map(r => toNumber(r[col], false));
      traces.push({ type:'bar', x, y, name: col.replace(subject+'|',''), yaxis:'y' });
    });

    percKeys.forEach(col => {
      const y = rows.map(r => toNumber(r[col], true));
      traces.push({
        type:'bar', x, y, name: col.replace(subject+'|',''), yaxis:'y2',
        text: y.map(v => (v*100).toFixed(1) + '%'), textposition:'outside'
      });
    });

    if(!traces.length){ alert('Não encontrei colunas para '+subject); return; }

    const layout = {
      title: subject, barmode:'group', font:{color:'#e2e8f0'},
      paper_bgcolor:'transparent', plot_bgcolor:'transparent',
      xaxis:{ gridcolor:'#1f2a44', title:xKey },
      yaxis:{ gridcolor:'#1f2a44', title:'Quantidade' },
      yaxis2:{ gridcolor:'#1f2a44', overlaying:'y', side:'right', tickformat:'.0%', range:[0,1], title:'Percentual' },
      legend:{orientation:'h', x:0, y:1.12},
      margin:{l:60,r:60,t:60,b:60}
    };

    Plotly.newPlot('chartHost', traces, layout, {responsive:true, displaylogo:false});
  }

  async function init(){
    try{
      const res = await fetch('data/Bimestral.xlsx');
      if(!res.ok) throw new Error('Erro '+res.status+' ao carregar data/Bimestral.xlsx');
      const ab = await res.arrayBuffer();
      state.wb = XLSX.read(ab, { type:'array' });
      state.firstSheet = state.wb.SheetNames[0];
      sheetToJSON(state.firstSheet);
      setStatus('Aba: '+state.firstSheet+' | Colunas: '+state.columns.slice(0,6).join(', ')+(state.columns.length>6?'…':''));
    }catch(e){ setStatus('Falha ao carregar planilha: '+e.message); console.error(e); }
  }

  document.getElementById('btnMath').addEventListener('click', ()=> plotCustom(state.firstSheet, 'Matemática|%≥6'));
  document.getElementById('btnPort').addEventListener('click', ()=> plotCustom(state.firstSheet, 'Português|%≥6'));
  document.getElementById('btnCompare').addEventListener('click', ()=> plotCompare(state.firstSheet, 'Matemática|%≥6', 'Português|%≥6'));

  document.getElementById('btnBioDet').addEventListener('click', ()=> plotSubjectDetailed(state.firstSheet, 'Biologia'));
  document.getElementById('btnMatDet').addEventListener('click', ()=> plotSubjectDetailed(state.firstSheet, 'Matemática'));
  document.getElementById('btnPorDet').addEventListener('click', ()=> plotSubjectDetailed(state.firstSheet, 'Português'));

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
